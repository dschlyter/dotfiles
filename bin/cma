#!/usr/bin/env python3

import argparse
import subprocess
import os
import unittest
import json
from pathlib import Path


def main():
    # https://docs.python.org/3/library/argparse.html
    global_parser = argparse.ArgumentParser(description='Claude manager - utilities to manage Claude')

    global_parser.set_defaults(handler=lambda *args, **kwargs: global_parser.print_help())
    sub_ps = global_parser.add_subparsers()

    sp = sub_ps.add_parser('lift', help='move last permission from project to global settings')
    sp.set_defaults(handler=lift)

    parsed_args = global_parser.parse_args()
    # Note: All handlers must have **kwargs to handle global args
    parsed_args.handler(**parsed_args.__dict__)


def lift(**kwargs):
    """Move the last permission from project .claude/settings.json to global ~/.claude/settings.json"""
    # 1. Find git root (if in git repo), otherwise use current directory
    try:
        git_root = sh_read("git rev-parse --show-toplevel 2>/dev/null")
    except subprocess.CalledProcessError:
        git_root = os.getcwd()

    # 2. Read project settings (check both settings.local.json and settings.json)
    project_settings_path = Path(git_root) / ".claude" / "settings.local.json"
    if not project_settings_path.exists():
        project_settings_path = Path(git_root) / ".claude" / "settings.json"
        if not project_settings_path.exists():
            print(f"Error: No settings file found in {Path(git_root) / '.claude'}")
            return

    with open(project_settings_path, 'r') as f:
        project_settings = json.load(f)

    # 3. Get and remove last permission
    if 'permissions' not in project_settings or 'allow' not in project_settings['permissions']:
        print("Error: No permissions found in project settings")
        return

    last_permission = project_settings['permissions']['allow'].pop()

    # 4. Add to global settings
    global_settings_path = Path.home() / ".claude" / "settings.json"
    global_settings_path.parent.mkdir(parents=True, exist_ok=True)

    if global_settings_path.exists():
        with open(global_settings_path, 'r') as f:
            global_settings = json.load(f)
    else:
        global_settings = {}

    if 'permissions' not in global_settings:
        global_settings['permissions'] = {}
    if 'allow' not in global_settings['permissions']:
        global_settings['permissions']['allow'] = []

    # Avoid duplicates
    if last_permission not in global_settings['permissions']['allow']:
        global_settings['permissions']['allow'].append(last_permission)

    # Write both files
    with open(project_settings_path, 'w') as f:
        json.dump(project_settings, f, indent=2)

    with open(global_settings_path, 'w') as f:
        json.dump(global_settings, f, indent=2)

    print(f"âœ“ Moved to global: {last_permission}")


def sh(command):
    subprocess.check_call(['/bin/bash', '-o', 'pipefail', '-c', command])


def sh_read(command):
    return subprocess.check_output(['/bin/bash', '-o', 'pipefail', '-c', command]).decode("utf-8").strip()


def get(li, i, default=None):
    if i < 0 or i >= len(li):
        return default
    return li[i]


# Inline tests
# Run by setting UNITTEST=1
class Tests(unittest.TestCase):
    def test_upper(self):
        self.assertEqual('foo'.upper(), 'FOO')


if __name__ == '__main__':
    if os.environ.get("UNITTEST") == "1":
        unittest.main()
    else:
        main()
