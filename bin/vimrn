#!/bin/bash
# vimrn - batch rename files using vim

ORIGFILE="/tmp/vimrn-orig-$$"
RNFILE="/tmp/vimrn-rn-$$"

if [ "$1" ]; then
    if [ -d "$1" ]; then
        cd "$1"
    else
        echo "No such directory"
    fi
fi

ls -1 > $ORIGFILE
cp $ORIGFILE $RNFILE
vim $RNFILE
if ! [ "$(diff $ORIGFILE $RNFILE)" ]; then
    echo "No changes were made"
elif [ "$(ls -1 | diff $ORIGFILE -)" ]; then
    echo "Error: Directory has been changed while editing"
elif [ $(cat $ORIGFILE | wc -l) != $(cat $RNFILE | wc -l) ]; then
    echo "Error: Line count not equal"
elif [ $(cat $RNFILE | sort | uniq | wc -l) != $(cat $ORIGFILE | wc -l) ]; then
    echo "Error: Duplicates exist in new names"
elif [ $(grep -ce '^$' $RNFILE) -gt 0 ]; then
    echo "Error: Empty lines exist"
else
    FD1=7
    FD2=8
    exec 7<$ORIGFILE
    exec 8<$RNFILE
    c=0
    # do renames twice as a hacky way to handle name swaps
    while read orig <&$FD1; do
        read newname <&$FD2
        if [ "$orig" != "$newname" ]; then
            mv "$orig" "$newname-VIMRN-$$-$c"
        fi
        c=$((c+1))
    done

    exec 7<$ORIGFILE
    exec 8<$RNFILE
    c=0
    while read orig <&$FD1; do
        read newname <&$FD2
        if [ "$orig" != "$newname" ]; then
            mv "$newname-VIMRN-$$-$c" "$newname"
        fi
        c=$((c+1))
    done
fi

rm $ORIGFILE
rm $RNFILE

